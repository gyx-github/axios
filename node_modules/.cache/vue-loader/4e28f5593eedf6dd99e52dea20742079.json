{"remainingRequest":"/Users/yanxugong/Workspace/01 Code/file-upload/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yanxugong/Workspace/01 Code/file-upload/src/views/Upload.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yanxugong/Workspace/01 Code/file-upload/src/views/Upload.vue","mtime":1581566766788},{"path":"/Users/yanxugong/Workspace/01 Code/file-upload/node_modules/cache-loader/dist/cjs.js","mtime":1580041481289},{"path":"/Users/yanxugong/Workspace/01 Code/file-upload/node_modules/babel-loader/lib/index.js","mtime":1574436104827},{"path":"/Users/yanxugong/Workspace/01 Code/file-upload/node_modules/cache-loader/dist/cjs.js","mtime":1580041481289},{"path":"/Users/yanxugong/Workspace/01 Code/file-upload/node_modules/vue-loader/lib/index.js","mtime":1580041499935}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmNvbnN0IFNJWkUgPSAxMCAqIDEwMjQgKiAxMDI0IC8vIOWIh+eJh+Wkp+WwjwoKY29uc3QgU3RhdHVzID0gewogIHdhaXQ6ICd3YWl0JywKICBwYXVzZTogJ3BhdXNlJywKICB1cGxvYWRpbmc6ICd1cGxvYWRpbmcnCn0KCmV4cG9ydCBkZWZhdWx0IHsKICBmaWx0ZXJzOiB7CiAgICB0cmFuc2Zvcm1CeXRlKHZhbCkgewogICAgICByZXR1cm4gTnVtYmVyKCh2YWwgLyAxMDI0KS50b0ZpeGVkKDApKQogICAgfQogIH0sCiAgZGF0YTogKCkgPT4gKHsKICAgIFN0YXR1cywKICAgIGNvbnRhaW5lcjogewogICAgICBmaWxlOiBudWxsLAogICAgICBoYXNoOiAnJywKICAgICAgd29ya2VyOiBudWxsCiAgICB9LAogICAgaGFzaFBlcmNlbnRhZ2U6IDAsCiAgICBkYXRhOiBbXSwKICAgIHJlcXVlc3RMaXN0OiBbXSwKICAgIHN0YXR1czogU3RhdHVzLndhaXQsCiAgICAvLyDlvZPmmoLlgZzml7bkvJrlj5bmtoggeGhyIOWvvOiHtOi/m+W6puadoeWQjumAgAogICAgLy8g5Li65LqG6YG/5YWN6L+Z56eN5oOF5Ya177yM6ZyA6KaB5a6a5LmJ5LiA5Liq5YGH55qE6L+b5bqm5p2hCiAgICBmYWtlVXBsb2FkUGVyY2VudGFnZTogMAogIH0pLAogIHdhdGNoOiB7CiAgICB1cGxvYWRQZXJjZW50YWdlKG5ld1ZhbHVlKSB7CiAgICAgIGlmIChuZXdWYWx1ZSA+IHRoaXMuZmFrZVVwbG9hZFBlcmNlbnRhZ2UpIHsKICAgICAgICB0aGlzLmZha2VVcGxvYWRQZXJjZW50YWdlID0gbmV3VmFsdWUKICAgICAgfQogICAgfQogIH0sCiAgY29tcHV0ZWQ6IHsKICAgIHVwbG9hZERpc2FibGVkKCkgewogICAgICByZXR1cm4gKAogICAgICAgICF0aGlzLmNvbnRhaW5lci5maWxlIHx8CiAgICAgICAgW1N0YXR1cy5wYXVzZSwgU3RhdHVzLnVwbG9hZGluZ10uaW5jbHVkZXModGhpcy5zdGF0dXMpCiAgICAgICkKICAgIH0sCiAgICB1cGxvYWRQZXJjZW50YWdlKCkgewogICAgICBpZiAoIXRoaXMuY29udGFpbmVyLmZpbGUgfHwgIXRoaXMuZGF0YS5sZW5ndGgpIHJldHVybiAwCiAgICAgIGNvbnN0IGxvYWRlZCA9IHRoaXMuZGF0YQogICAgICAgIC5tYXAoaXRlbSA9PiBpdGVtLnNpemUgKiBpdGVtLnBlcmNlbnRhZ2UpCiAgICAgICAgLnJlZHVjZSgoYWNjLCBjdXIpID0+IGFjYyArIGN1cikKICAgICAgcmV0dXJuIHBhcnNlSW50KChsb2FkZWQgLyB0aGlzLmNvbnRhaW5lci5maWxlLnNpemUpLnRvRml4ZWQoMikpCiAgICB9CiAgfSwKICBtZXRob2RzOiB7CiAgICBoYW5kbGVQYXVzZSgpIHsKICAgICAgdGhpcy5zdGF0dXMgPSBTdGF0dXMucGF1c2UKICAgICAgdGhpcy5yZXNldERhdGEoKQogICAgfSwKICAgIHJlc2V0RGF0YSgpIHsKICAgICAgdGhpcy5yZXF1ZXN0TGlzdC5mb3JFYWNoKHhociA9PiB4aHI/LmFib3J0KCkpCiAgICAgIHRoaXMucmVxdWVzdExpc3QgPSBbXQogICAgICBpZiAodGhpcy5jb250YWluZXIud29ya2VyKSB7CiAgICAgICAgdGhpcy5jb250YWluZXIud29ya2VyLm9ubWVzc2FnZSA9IG51bGwKICAgICAgfQogICAgfSwKICAgIHJlcXVlc3QoewogICAgICB1cmwsCiAgICAgIG1ldGhvZCA9ICdwb3N0JywKICAgICAgZGF0YSwKICAgICAgaGVhZGVycyA9IHt9LAogICAgICBvblByb2dyZXNzID0gZSA9PiBlLAogICAgICByZXF1ZXN0TGlzdAogICAgfSkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7CiAgICAgICAgY29uc3QgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCkKICAgICAgICB4aHIudXBsb2FkLm9ucHJvZ3Jlc3MgPSBvblByb2dyZXNzCiAgICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwpCiAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVycykuZm9yRWFjaChrZXkgPT4KICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgaGVhZGVyc1trZXldKQogICAgICAgICkKICAgICAgICB4aHIuc2VuZChkYXRhKQogICAgICAgIHhoci5vbmxvYWQgPSBlID0+IHsKICAgICAgICAgIC8vIOWwhuivt+axguaIkOWKn+eahCB4aHIg5LuO5YiX6KGo5Lit5Yig6ZmkCiAgICAgICAgICBpZiAocmVxdWVzdExpc3QpIHsKICAgICAgICAgICAgY29uc3QgeGhySW5kZXggPSByZXF1ZXN0TGlzdC5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSB4aHIpCiAgICAgICAgICAgIHJlcXVlc3RMaXN0LnNwbGljZSh4aHJJbmRleCwgMSkKICAgICAgICAgIH0KICAgICAgICAgIHJlc29sdmUoewogICAgICAgICAgICBkYXRhOiBlLnRhcmdldC5yZXNwb25zZQogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgICAgLy8g5pq06Zyy5b2T5YmNIHhociDnu5nlpJbpg6gKICAgICAgICByZXF1ZXN0TGlzdCAmJiByZXF1ZXN0TGlzdC5wdXNoKHhocikKICAgICAgfSkKICAgIH0sCiAgICAvLyDnlJ/miJDmlofku7bliIfniYcKICAgIGNyZWF0ZUZpbGVDaHVuayhmaWxlLCBzaXplID0gU0laRSkgewogICAgICBjb25zdCBmaWxlQ2h1bmtMaXN0ID0gW10KICAgICAgbGV0IHN1bSA9IDAKICAgICAgLy8g5b2T5ruh6Laz5p2h5Lu25pe26L+b5YWl5b6q546v77yM6L+b5YWl5b6q546v5ZCO77yM5b2T5p2h5Lu25LiN5ruh6Laz5pe277yM6Lez5Ye65b6q546vCiAgICAgIHdoaWxlIChzdW0gPCBmaWxlLnNpemUpIHsKICAgICAgICBmaWxlQ2h1bmtMaXN0LnB1c2goeyBmaWxlOiBmaWxlLnNsaWNlKHN1bSwgc3VtICsgc2l6ZSkgfSkKICAgICAgICBzdW0gKz0gc2l6ZQogICAgICB9CiAgICAgIHJldHVybiBmaWxlQ2h1bmtMaXN0CiAgICB9LAogICAgLy8g55Sf5oiQ5paH5Lu2IGhhc2ggKHdlYi13b3JrZXIpCiAgICBjYWxjdWxhdGVIYXNoKGZpbGVDaHVua0xpc3QpIHsKICAgICAgZGVidWdnZXIKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewogICAgICAgIC8vIOa3u+WKoCB3b3JrZXIg5bGe5oCnCiAgICAgICAgdGhpcy5jb250YWluZXIud29ya2VyID0gbmV3IFdvcmtlcignL2hhc2guanMnKQogICAgICAgIHRoaXMuY29udGFpbmVyLndvcmtlci5wb3N0TWVzc2FnZSh7IGZpbGVDaHVua0xpc3QgfSkKICAgICAgICB0aGlzLmNvbnRhaW5lci53b3JrZXIub25tZXNzYWdlID0gZSA9PiB7CiAgICAgICAgICBjb25zdCB7IHBlcmNlbnRhZ2UsIGhhc2ggfSA9IGUuZGF0YQogICAgICAgICAgdGhpcy5oYXNoUGVyY2VudGFnZSA9IHBlcmNlbnRhZ2UKICAgICAgICAgIGlmIChoYXNoKSB7CiAgICAgICAgICAgIHJlc29sdmUoaGFzaCkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pCiAgICB9LAogICAgaGFuZGxlRmlsZUNoYW5nZShlKSB7CiAgICAgIGNvbnN0IFtmaWxlXSA9IGUudGFyZ2V0LmZpbGVzCiAgICAgIGlmICghZmlsZSkgcmV0dXJuCiAgICAgIHRoaXMucmVzZXREYXRhKCkKICAgICAgLy8g5bCG5b2T5YmN54q25oCB55qEZGF0YemHjee9ruS4uuWIneWni+eKtuaAgQogICAgICBPYmplY3QuYXNzaWduKHRoaXMuJGRhdGEsIHRoaXMuJG9wdGlvbnMuZGF0YSgpKQogICAgICB0aGlzLmNvbnRhaW5lci5maWxlID0gZmlsZQogICAgfSwKICAgIGNyZWF0ZVByb2dyZXNzSGFuZGxlcihpdGVtKSB7CiAgICAgIHJldHVybiBlID0+IHsKICAgICAgICBpdGVtLnBlcmNlbnRhZ2UgPSBwYXJzZUludChTdHJpbmcoKGUubG9hZGVkIC8gZS50b3RhbCkgKiAxMDApKQogICAgICB9CiAgICB9LAogICAgYXN5bmMgaGFuZGxlUmVzdW1lKCkgewogICAgICB0aGlzLnN0YXR1cyA9IFN0YXR1cy51cGxvYWRpbmcKICAgICAgY29uc3QgeyB1cGxvYWRlZExpc3QgfSA9IGF3YWl0IHRoaXMudmVyaWZ5VXBsb2FkKAogICAgICAgIHRoaXMuY29udGFpbmVyLmZpbGUubmFtZSwKICAgICAgICB0aGlzLmNvbnRhaW5lci5oYXNoCiAgICAgICkKICAgICAgYXdhaXQgdGhpcy51cGxvYWRDaHVua3ModXBsb2FkZWRMaXN0KQogICAgfSwKICAgIGFzeW5jIGhhbmRsZVVwbG9hZCgpIHsKICAgICAgZGVidWdnZXIKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lci5maWxlKSByZXR1cm4KICAgICAgdGhpcy5zdGF0dXMgPSBTdGF0dXMudXBsb2FkaW5nCiAgICAgIGNvbnN0IGZpbGVDaHVua0xpc3QgPSB0aGlzLmNyZWF0ZUZpbGVDaHVuayh0aGlzLmNvbnRhaW5lci5maWxlKQogICAgICB0aGlzLmNvbnRhaW5lci5oYXNoID0gYXdhaXQgdGhpcy5jYWxjdWxhdGVIYXNoKGZpbGVDaHVua0xpc3QpCgogICAgICBjb25zdCB7IHNob3VsZFVwbG9hZCwgdXBsb2FkZWRMaXN0IH0gPSBhd2FpdCB0aGlzLnZlcmlmeVVwbG9hZCgKICAgICAgICB0aGlzLmNvbnRhaW5lci5maWxlLm5hbWUsCiAgICAgICAgdGhpcy5jb250YWluZXIuaGFzaAogICAgICApCiAgICAgIGlmICghc2hvdWxkVXBsb2FkKSB7CiAgICAgICAgdGhpcy4kbWVzc2FnZS5zdWNjZXNzKCfnp5LkvKDvvJrkuIrkvKDmiJDlip8nKQogICAgICAgIHRoaXMuc3RhdHVzID0gU3RhdHVzLndhaXQKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgdGhpcy5kYXRhID0gZmlsZUNodW5rTGlzdC5tYXAoKHsgZmlsZSB9LCBpbmRleCkgPT4gKHsKICAgICAgICBmaWxlSGFzaDogdGhpcy5jb250YWluZXIuaGFzaCwKICAgICAgICBpbmRleCwKICAgICAgICBoYXNoOiBgJHt0aGlzLmNvbnRhaW5lci5maWxlLm5hbWV9LSR7aW5kZXh9YCwgLy8g5paH5Lu25ZCNICsg5pWw57uE5LiL5qCHCiAgICAgICAgY2h1bms6IGZpbGUsCiAgICAgICAgc2l6ZTogZmlsZS5zaXplLAogICAgICAgIHBlcmNlbnRhZ2U6IHVwbG9hZGVkTGlzdC5pbmNsdWRlcyhpbmRleCkgPyAxMDAgOiAwCiAgICAgIH0pKQoKICAgICAgYXdhaXQgdGhpcy51cGxvYWRDaHVua3ModXBsb2FkZWRMaXN0KQogICAgfSwKICAgIC8vIOS4iuS8oOWIh+eJhwogICAgYXN5bmMgdXBsb2FkQ2h1bmtzKHVwbG9hZGVkTGlzdCA9IFtdKSB7CiAgICAgIGNvbnN0IHJlcXVlc3RMaXN0ID0gdGhpcy5kYXRhCiAgICAgICAgLmZpbHRlcigoeyBoYXNoIH0pID0+ICF1cGxvYWRlZExpc3QuaW5jbHVkZXMoaGFzaCkpCiAgICAgICAgLm1hcCgoeyBjaHVuaywgaGFzaCwgaW5kZXggfSkgPT4gewogICAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKQogICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdjaHVuaycsIGNodW5rKQogICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdoYXNoJywgaGFzaCkKICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZW5hbWUnLCB0aGlzLmNvbnRhaW5lci5maWxlLm5hbWUpCiAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGVIYXNoJywgdGhpcy5jb250YWluZXIuaGFzaCkKICAgICAgICAgIHJldHVybiB7IGZvcm1EYXRhLCBpbmRleCB9CiAgICAgICAgfSkKICAgICAgICAubWFwKGFzeW5jICh7IGZvcm1EYXRhLCBpbmRleCB9KSA9PgogICAgICAgICAgdGhpcy5yZXF1ZXN0KHsKICAgICAgICAgICAgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDozMDAwJywKICAgICAgICAgICAgZGF0YTogZm9ybURhdGEsCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IHRoaXMuY3JlYXRlUHJvZ3Jlc3NIYW5kbGVyKHRoaXMuZGF0YVtpbmRleF0pLAogICAgICAgICAgICByZXF1ZXN0TGlzdDogdGhpcy5yZXF1ZXN0TGlzdAogICAgICAgICAgfSkKICAgICAgICApCiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHJlcXVlc3RMaXN0KSAvLyDlubblj5HliIfniYcKICAgICAgLy8g5LmL5YmN5LiK5Lyg55qE5YiH54mH5pWw6YePICsg5pys5qyh5LiK5Lyg55qE5YiH54mH5pWw6YePID0g5omA5pyJ5YiH54mH5pWw6YeP5pe2CiAgICAgIC8vIOWQiOW5tuWIh+eJhwogICAgICBpZiAodXBsb2FkZWRMaXN0Lmxlbmd0aCArIHJlcXVlc3RMaXN0Lmxlbmd0aCA9PT0gdGhpcy5kYXRhLmxlbmd0aCkgewogICAgICAgIGF3YWl0IHRoaXMubWVyZ2VSZXF1ZXN0KCkKICAgICAgfQogICAgfSwKICAgIGFzeW5jIG1lcmdlUmVxdWVzdCgpIHsKICAgICAgLy8gZGVidWdnZXIKICAgICAgYXdhaXQgdGhpcy5yZXF1ZXN0KHsKICAgICAgICB1cmw6ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvbWVyZ2UnLAogICAgICAgIGhlYWRlcnM6IHsgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LAogICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIHNpemU6IFNJWkUsCiAgICAgICAgICBmaWxlSGFzaDogdGhpcy5jb250YWluZXIuaGFzaCwKICAgICAgICAgIGZpbGVuYW1lOiB0aGlzLmNvbnRhaW5lci5maWxlLm5hbWUKICAgICAgICB9KQogICAgICB9KQogICAgICB0aGlzLiRtZXNzYWdlLnN1Y2Nlc3MoJ+S4iuS8oOaIkOWKnycpCiAgICAgIHRoaXMuc3RhdHVzID0gU3RhdHVzLndhaXQKICAgIH0sCiAgICBhc3luYyB2ZXJpZnlVcGxvYWQoZmlsZW5hbWUsIGZpbGVIYXNoKSB7CiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5yZXF1ZXN0KHsKICAgICAgICB1cmw6ICdodHRwOi8vbG9jYWxob3N0OjMwMDAvdmVyaWZ5JywKICAgICAgICBoZWFkZXJzOiB7ICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSwKICAgICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBmaWxlbmFtZSwKICAgICAgICAgIGZpbGVIYXNoCiAgICAgICAgfSkKICAgICAgfSkKICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSkKICAgIH0KICB9Cn0K"},{"version":3,"sources":["Upload.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0DA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Upload.vue","sourceRoot":"src/views","sourcesContent":["<!--\n * @Descripttion: 上传\n * @Author: yanxu gong\n * @Date: 2020-01-26 20:52:05\n * @LastEditors  : yanxu gong\n * @LastEditTime : 2020-02-13 12:06:06\n -->\n<template>\n  <div>\n    <div class=\"upload\">\n      <input\n        type=\"file\"\n        :disabled=\"status !== Status.wait\"\n        @change=\"handleFileChange\"\n      />\n      <el-button @click=\"handleUpload\" :disabled=\"uploadDisabled\"\n        >上传</el-button\n      >\n      <el-button @click=\"handleResume\" v-if=\"status === Status.pause\"\n        >恢复</el-button\n      >\n      <el-button\n        v-else\n        @click=\"handlePause\"\n        :disabled=\"status !== Status.uploading || !container.hash\"\n        >暂停</el-button\n      >\n    </div>\n    <div>\n      <div>计算文件 hash</div>\n      <el-progress :percentage=\"hashPercentage\"></el-progress>\n      <div>总进度</div>\n      <el-progress :percentage=\"fakeUploadPercentage\"></el-progress>\n    </div>\n    <el-table :data=\"data\">\n      <el-table-column\n        prop=\"hash\"\n        label=\"切片hash\"\n        align=\"center\"\n      ></el-table-column>\n      <el-table-column label=\"大小(KB)\" align=\"center\" width=\"120\">\n        <template v-slot=\"{ row }\">\n          {{ row.size | transformByte }}\n        </template>\n      </el-table-column>\n      <el-table-column label=\"进度\" align=\"center\">\n        <template v-slot=\"{ row }\">\n          <el-progress\n            :percentage=\"row.percentage\"\n            color=\"#909399\"\n          ></el-progress>\n        </template>\n      </el-table-column>\n    </el-table>\n  </div>\n</template>\n\n<script>\nconst SIZE = 10 * 1024 * 1024 // 切片大小\n\nconst Status = {\n  wait: 'wait',\n  pause: 'pause',\n  uploading: 'uploading'\n}\n\nexport default {\n  filters: {\n    transformByte(val) {\n      return Number((val / 1024).toFixed(0))\n    }\n  },\n  data: () => ({\n    Status,\n    container: {\n      file: null,\n      hash: '',\n      worker: null\n    },\n    hashPercentage: 0,\n    data: [],\n    requestList: [],\n    status: Status.wait,\n    // 当暂停时会取消 xhr 导致进度条后退\n    // 为了避免这种情况，需要定义一个假的进度条\n    fakeUploadPercentage: 0\n  }),\n  watch: {\n    uploadPercentage(newValue) {\n      if (newValue > this.fakeUploadPercentage) {\n        this.fakeUploadPercentage = newValue\n      }\n    }\n  },\n  computed: {\n    uploadDisabled() {\n      return (\n        !this.container.file ||\n        [Status.pause, Status.uploading].includes(this.status)\n      )\n    },\n    uploadPercentage() {\n      if (!this.container.file || !this.data.length) return 0\n      const loaded = this.data\n        .map(item => item.size * item.percentage)\n        .reduce((acc, cur) => acc + cur)\n      return parseInt((loaded / this.container.file.size).toFixed(2))\n    }\n  },\n  methods: {\n    handlePause() {\n      this.status = Status.pause\n      this.resetData()\n    },\n    resetData() {\n      this.requestList.forEach(xhr => xhr?.abort())\n      this.requestList = []\n      if (this.container.worker) {\n        this.container.worker.onmessage = null\n      }\n    },\n    request({\n      url,\n      method = 'post',\n      data,\n      headers = {},\n      onProgress = e => e,\n      requestList\n    }) {\n      return new Promise(resolve => {\n        const xhr = new XMLHttpRequest()\n        xhr.upload.onprogress = onProgress\n        xhr.open(method, url)\n        Object.keys(headers).forEach(key =>\n          xhr.setRequestHeader(key, headers[key])\n        )\n        xhr.send(data)\n        xhr.onload = e => {\n          // 将请求成功的 xhr 从列表中删除\n          if (requestList) {\n            const xhrIndex = requestList.findIndex(item => item === xhr)\n            requestList.splice(xhrIndex, 1)\n          }\n          resolve({\n            data: e.target.response\n          })\n        }\n        // 暴露当前 xhr 给外部\n        requestList && requestList.push(xhr)\n      })\n    },\n    // 生成文件切片\n    createFileChunk(file, size = SIZE) {\n      const fileChunkList = []\n      let sum = 0\n      // 当满足条件时进入循环，进入循环后，当条件不满足时，跳出循环\n      while (sum < file.size) {\n        fileChunkList.push({ file: file.slice(sum, sum + size) })\n        sum += size\n      }\n      return fileChunkList\n    },\n    // 生成文件 hash (web-worker)\n    calculateHash(fileChunkList) {\n      debugger\n      return new Promise(resolve => {\n        // 添加 worker 属性\n        this.container.worker = new Worker('/hash.js')\n        this.container.worker.postMessage({ fileChunkList })\n        this.container.worker.onmessage = e => {\n          const { percentage, hash } = e.data\n          this.hashPercentage = percentage\n          if (hash) {\n            resolve(hash)\n          }\n        }\n      })\n    },\n    handleFileChange(e) {\n      const [file] = e.target.files\n      if (!file) return\n      this.resetData()\n      // 将当前状态的data重置为初始状态\n      Object.assign(this.$data, this.$options.data())\n      this.container.file = file\n    },\n    createProgressHandler(item) {\n      return e => {\n        item.percentage = parseInt(String((e.loaded / e.total) * 100))\n      }\n    },\n    async handleResume() {\n      this.status = Status.uploading\n      const { uploadedList } = await this.verifyUpload(\n        this.container.file.name,\n        this.container.hash\n      )\n      await this.uploadChunks(uploadedList)\n    },\n    async handleUpload() {\n      debugger\n      if (!this.container.file) return\n      this.status = Status.uploading\n      const fileChunkList = this.createFileChunk(this.container.file)\n      this.container.hash = await this.calculateHash(fileChunkList)\n\n      const { shouldUpload, uploadedList } = await this.verifyUpload(\n        this.container.file.name,\n        this.container.hash\n      )\n      if (!shouldUpload) {\n        this.$message.success('秒传：上传成功')\n        this.status = Status.wait\n        return\n      }\n\n      this.data = fileChunkList.map(({ file }, index) => ({\n        fileHash: this.container.hash,\n        index,\n        hash: `${this.container.file.name}-${index}`, // 文件名 + 数组下标\n        chunk: file,\n        size: file.size,\n        percentage: uploadedList.includes(index) ? 100 : 0\n      }))\n\n      await this.uploadChunks(uploadedList)\n    },\n    // 上传切片\n    async uploadChunks(uploadedList = []) {\n      const requestList = this.data\n        .filter(({ hash }) => !uploadedList.includes(hash))\n        .map(({ chunk, hash, index }) => {\n          const formData = new FormData()\n          formData.append('chunk', chunk)\n          formData.append('hash', hash)\n          formData.append('filename', this.container.file.name)\n          formData.append('fileHash', this.container.hash)\n          return { formData, index }\n        })\n        .map(async ({ formData, index }) =>\n          this.request({\n            url: 'http://localhost:3000',\n            data: formData,\n            onProgress: this.createProgressHandler(this.data[index]),\n            requestList: this.requestList\n          })\n        )\n      await Promise.all(requestList) // 并发切片\n      // 之前上传的切片数量 + 本次上传的切片数量 = 所有切片数量时\n      // 合并切片\n      if (uploadedList.length + requestList.length === this.data.length) {\n        await this.mergeRequest()\n      }\n    },\n    async mergeRequest() {\n      // debugger\n      await this.request({\n        url: 'http://localhost:3000/merge',\n        headers: { 'content-type': 'application/json' },\n        data: JSON.stringify({\n          size: SIZE,\n          fileHash: this.container.hash,\n          filename: this.container.file.name\n        })\n      })\n      this.$message.success('上传成功')\n      this.status = Status.wait\n    },\n    async verifyUpload(filename, fileHash) {\n      const { data } = await this.request({\n        url: 'http://localhost:3000/verify',\n        headers: { 'content-type': 'application/json' },\n        data: JSON.stringify({\n          filename,\n          fileHash\n        })\n      })\n      return JSON.parse(data)\n    }\n  }\n}\n</script>\n"]}]}